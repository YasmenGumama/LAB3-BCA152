#include "stm32f4xx_hal.h"
#include <string.h>
#include <stdio.h>
I2C_HandleTypeDef hi2c1;
UART_HandleTypeDef huart1;
#define RTC_ADDRESS 0x68 << 1 // DS1307/DS3231 7-bit address shifted for HAL
#define LED_PIN GPIO_PIN_5
#define LED_PORT GPIOD
// Function prototypes
void SystemClock_Config(void);
static void MX_GPIO_Init(void);
static void MX_I2C1_Init(void);
static void MX_USART1_UART_Init(void);
uint8_t bcd2bin(uint8_t val);
uint8_t bin2bcd(uint8_t val);
void RTC_SetTime(uint8_t hour, uint8_t min, uint8_t sec);
uint8_t RTC_GetHour(void);
int main(void)
{
HAL_Init();
SystemClock_Config();
MX_GPIO_Init();
MX_I2C1_Init();
MX_USART1_UART_Init();
// Set RTC time to 07:00:00
RTC_SetTime(7, 0, 0);
char msg[50];
while (1)
{
uint8_t hour = RTC_GetHour();
// Print hour to PC
sprintf(msg, "Current hour: %02d\r\n", hour);
HAL_UART_Transmit(&huart1, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);
// Set or clear PD5 based on hour
if(hour == 7)
HAL_GPIO_WritePin(LED_PORT, LED_PIN, GPIO_PIN_SET);
else
HAL_GPIO_WritePin(LED_PORT, LED_PIN, GPIO_PIN_RESET);
HAL_Delay(1000);
}
}
// Convert BCD to binary
uint8_t bcd2bin(uint8_t val)
{
return ((val >> 4) * 10 + (val & 0x0F));
}
// Convert binary to BCD
uint8_t bin2bcd(uint8_t val)
{
return (((val / 10) << 4) | (val % 10));
}
// Set RTC time
void RTC_SetTime(uint8_t hour, uint8_t min, uint8_t sec)
{
uint8_t data[3];
data[0] = bin2bcd(sec);
data[1] = bin2bcd(min);
data[2] = bin2bcd(hour);
HAL_I2C_Mem_Write(&hi2c1, RTC_ADDRESS, 0x00, 1, data, 3, HAL_MAX_DELAY);
}
// Get RTC hour
uint8_t RTC_GetHour(void)
{
uint8_t hour;
HAL_I2C_Mem_Read(&hi2c1, RTC_ADDRESS, 0x02, 1, &hour, 1, HAL_MAX_DELAY);
return bcd2bin(hour);
}
/* Auto-generated initialization functions (CubeMX) */
static void MX_GPIO_Init(void)
{
__HAL_RCC_GPIOD_CLK_ENABLE();
GPIO_InitTypeDef GPIO_InitStruct = {0};
GPIO_InitStruct.Pin = LED_PIN;
GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
GPIO_InitStruct.Pull = GPIO_NOPULL;
GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
HAL_GPIO_Init(LED_PORT, &GPIO_InitStruct);
}
static void MX_I2C1_Init(void)
{
__HAL_RCC_I2C1_CLK_ENABLE();
hi2c1.Instance = I2C1;
hi2c1.Init.ClockSpeed = 100000;
hi2c1.Init.DutyCycle = I2C_DUTYCYCLE_2;
hi2c1.Init.OwnAddress1 = 0;
hi2c1.Init.AddressingMode = I2C_ADDRESSINGMODE_7BIT;
hi2c1.Init.DualAddressMode = I2C_DUALADDRESS_DISABLE;
hi2c1.Init.OwnAddress2 = 0;
hi2c1.Init.GeneralCallMode = I2C_GENERALCALL_DISABLE;
hi2c1.Init.NoStretchMode = I2C_NOSTRETCH_DISABLE;
HAL_I2C_Init(&hi2c1);
}
static void MX_USART1_UART_Init(void)
{
huart1.Instance = USART1;
huart1.Init.BaudRate = 9600;
huart1.Init.WordLength = UART_WORDLENGTH_8B;
huart1.Init.StopBits = UART_STOPBITS_1;
huart1.Init.Parity = UART_PARITY_NONE;
huart1.Init.Mode = UART_MODE_TX_RX;
huart1.Init.HwFlowCtl = UART_HWCONTROL_NONE;
huart1.Init.OverSampling = UART_OVERSAMPLING_16;
HAL_UART_Init(&huart1);
}
void SystemClock_Config(void)
{
RCC_OscInitTypeDef RCC_OscInitStruct = {0};
RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};
RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
RCC_OscInitStruct.HSIState = RCC_HSI_ON;
RCC_OscInitStruct.HSICalibrationValue = 16;
RCC_OscInitStruct.PLL.PLLState = RCC_PLL_NONE;
HAL_RCC_OscConfig(&RCC_OscInitStruct);
RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
|RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_HSI;
RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_0);
